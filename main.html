<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markdown ç·¨è¼¯å™¨</title>
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }

    h1 {
      color: #333;
    }

    textarea {
      min-height: 300px;
    }

    .button-group {
      margin-top: 10px;
    }

    button {
      padding: 8px 16px;
      font-size: 16px;
      margin-right: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    /* === æ–°å¢: å°å‹åŠŸèƒ½åˆ— (miniMenu) çš„æ¨£å¼ === */
    #miniMenu {
      display: none; /* é è¨­éš±è— */
      position: absolute; /* çµ•å°å®šä½ */
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000; /* ç¢ºä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
      padding: 5px;
      border-radius: 4px;
      min-width: 80px; /* ç¢ºä¿è¶³å¤ å¯¬åº¦ */
    }

    .menu-item {
      padding: 5px 10px;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 1px solid #eee; /* åˆ†éš”ç·š */
    }

    .menu-item:last-child {
      border-bottom: none; /* æœ€å¾Œä¸€å€‹é …ç›®ç„¡åˆ†éš”ç·š */
    }

    .menu-item:hover {
      background-color: #f0f0f0;
    }

    /* è¦ç¯„èœå–®é …å…§çš„æ¨™é¡Œæ¨£å¼ */
    .menu-item h1, .menu-item h2, .menu-item h3,
    .menu-item h4, .menu-item h5, .menu-item h6 {
        margin: 0;
        padding: 0;
        font-size: 1em;
        font-weight: normal;
        line-height: 1.2;
    }
    /* === æ–°å¢æ¨£å¼çµæŸ === */
  </style>
</head>
<body>
  <h1>Markdown ç·¨è¼¯å™¨</h1>
  <textarea id="editor"></textarea>
  <div class="button-group">
    <button id="saveBtn">ğŸ’¾ ä¸‹è¼‰ .md</button>
    <button id="clearCacheBtn">ğŸ§¹ æ¸…é™¤æš«å­˜</button>
  </div>

  <div id="miniMenu">
    </div>
  <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
  <script>
    const STORAGE_KEY = "myMarkdownDraft";

    // åˆå§‹åŒ–ç·¨è¼¯å™¨
    const easyMDE = new EasyMDE({
      element: document.getElementById("editor"),
      spellChecker: false,
      placeholder: "è«‹è¼¸å…¥ Markdown å…§å®¹...",
    });

    // å˜—è©¦å¾ localStorage è¼‰å…¥æš«å­˜
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      easyMDE.value(saved);
    }

    // æ¯æ¬¡è®Šæ›´å°±æ›´æ–° localStorage æš«å­˜
    easyMDE.codemirror.on("change", () => {
      const markdown = easyMDE.value();
      localStorage.setItem(STORAGE_KEY, markdown);
    });

    // å¯¦é«”ä¸‹è¼‰ .md
    document.getElementById("saveBtn").addEventListener("click", () => {
      const markdownContent = easyMDE.value();
      const blob = new Blob([markdownContent], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "document.md";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // æ¸…é™¤æš«å­˜æŒ‰éˆ•
    document.getElementById("clearCacheBtn").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      alert("å·²æ¸…é™¤æš«å­˜ï¼");
      easyMDE.value(""); // æ¸…é™¤ç·¨è¼¯å™¨å…§å®¹
    });


    
    // æ–œç·šå‘½ä»¤
    const cm = easyMDE.codemirror; 
    const miniMenu = document.getElementById("miniMenu");
    let currentMenuLine = -1; 

    // å®šç¾©æ¨™é¡Œé¸é …
    const headingOptions = [
      { text: "H1", value: "# " },
      { text: "H2", value: "## " },
      { text: "H3", value: "### " },
      { text: "H4", value: "#### " },
      { text: "H5", value: "##### " },
      { text: "H6", value: "###### " },
    ];

    // é¡¯ç¤ºå°å‹åŠŸèƒ½åˆ—
    function showMiniMenu(coords) {
        miniMenu.style.display = "block";
        miniMenu.style.top = (coords.bottom + 5) + "px"; 
        miniMenu.style.left = coords.left + "px";
    }

    // éš±è—å°å‹åŠŸèƒ½åˆ—
    function hideMiniMenu() {
        miniMenu.style.display = "none";
        currentMenuLine = -1; 
    }

    // å‹•æ…‹è¼‰å…¥èœå–®é¸é …ä¸¦ç¶å®šé»æ“Šäº‹ä»¶
    headingOptions.forEach(option => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.dataset.value = option.value;
        div.innerHTML = `<${option.text.toLowerCase()}>${option.text}</${option.text.toLowerCase()}>`;
        miniMenu.appendChild(div);
    });

    // è™•ç†é¸é …é»æ“Šäº‹ä»¶
    miniMenu.addEventListener("click", (event) => {
        const target = event.target.closest(".menu-item"); 
        if (target) {
            const selectedValue = target.dataset.value;
            const cursor = cm.getCursor();
            const lineContent = cm.getLine(cursor.line);
            const slashIndex = lineContent.indexOf('/'); 

            cm.replaceRange(selectedValue, { line: cursor.line, ch: slashIndex }, { line: cursor.line, ch: slashIndex + 1 });
            cm.setCursor(cursor.line, slashIndex + selectedValue.length);
            
            hideMiniMenu(); 
            cm.focus(); 
        }
    });

    // ç›£è½ç·¨è¼¯å™¨å…§å®¹è®ŠåŒ–
    // ç›£è½ç·¨è¼¯å™¨å…§å®¹è®ŠåŒ–
    cm.on("change", (instance, changeObj) => {
        const cursor = instance.getCursor();
        const lineContent = instance.getLine(cursor.line);
        const trimmedLine = lineContent.trimStart();
        const slashIndex = lineContent.indexOf('/'); // å–å¾— '/' çš„å¯¦éš›ç´¢å¼•

        // åˆ¤æ–·é¡¯ç¤ºèœå–®çš„æ¢ä»¶
        // 1. æ˜¯å–®ä¸€è¼¸å…¥äº‹ä»¶ (éè²¼ä¸Šç­‰)
        // 2. è¼¸å…¥çš„å­—å…ƒæ˜¯ '/'
        // 3. ä¿®å‰ªç©ºç™½å¾Œçš„è¡Œå…§å®¹ä»¥ '/' é–‹é ­
        // 4. '/' æ˜¯ä¿®å‰ªå¾Œå…§å®¹çš„ç¬¬ä¸€å€‹å­—å…ƒ (å³è¡Œé¦–çš„éç©ºç™½å­—å…ƒæ˜¯ '/')
        // 5. æ¸¸æ¨™ä½æ–¼å‰›è¼¸å…¥çš„ '/' ä¹‹å¾Œ
        // 6. ç›®å‰æ²’æœ‰æ´»èºçš„èœå–®
        if (changeObj.origin === "+input" && changeObj.text[0] === '/' &&
            trimmedLine.startsWith('/') && lineContent.indexOf(trimmedLine) === slashIndex &&
            cursor.ch === slashIndex + 1 &&
            currentMenuLine === -1) {

            const coords = instance.charCoords({ line: cursor.line, ch: slashIndex }, "page");
            showMiniMenu(coords);
            currentMenuLine = cursor.line; 
        } else if (miniMenu.style.display === "block" && currentMenuLine === cursor.line) {
            // åˆ¤æ–·éš±è—èœå–®çš„æ¢ä»¶ ï¼š
            // 1. è¡Œå…§å®¹ä¸å†ä»¥ '/' é–‹é ­ 
            // 2. æˆ–è€… '/' ä¸å†æ˜¯è©²è¡Œéç©ºç™½å…§å®¹çš„ç¬¬ä¸€å€‹å­—å…ƒ
            // 3. æˆ–è€…æ¸¸æ¨™å·²ç§»å‹•åˆ° '/' å­—å…ƒä¹‹å¾Œä¸€å€‹ä½ç½®ä¹‹å¤–
            if (!trimmedLine.startsWith('/') || lineContent.indexOf(trimmedLine) !== slashIndex || cursor.ch > slashIndex + 1) {
                hideMiniMenu();
            }
        }
    });

    // æ¸¸æ¨™ç§»å‹•
    cm.on("cursorActivity", (instance) => {
        const cursor = instance.getCursor();
        if (miniMenu.style.display === "block" && currentMenuLine !== -1) { 
            if (cursor.line !== currentMenuLine) {//æ›è¡Œå‰‡å–æ¶ˆåˆ—è¡¨
                hideMiniMenu();
            } else {
                const lineContent = instance.getLine(cursor.line);
                const trimmedLine = lineContent.trimStart();
                const slashIndex = lineContent.indexOf('/'); // å–å¾— '/' çš„å¯¦éš›ç´¢å¼•

                if (!trimmedLine.startsWith('/') || lineContent.indexOf(trimmedLine) !== slashIndex || cursor.ch > slashIndex + 1) {
                    hideMiniMenu();
                }
            }
        }
    });

  </script>
</body>
</html>